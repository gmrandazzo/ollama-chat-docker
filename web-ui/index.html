<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Docker Chat</title>
    <style>
        :root {
            --bg-color: #282c34;
            --chat-bg: #343541;
            --user-msg-bg: #3a5a97;
            --ai-msg-bg: #444654;
            --text-color: #d1d5db;
            --input-bg: #40414f;
            --border-color: #565869;
            --header-bg: #343541;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #app-header { background-color: var(--header-bg); padding: 10px 20px; border-bottom: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .header-group { display: flex; flex-direction: column; gap: 5px; }
        .header-group label { font-size: 0.8em; color: #a0a4ab; }
        #model-select { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; font-size: 14px; }
        #pull-controls { display: flex; gap: 10px; }
        #pull-model-input { background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; color: var(--text-color); }
        #pull-model-btn { background-color: #565869; color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; }
        #pull-model-btn:hover { background-color: #676a79; }
        #pull-status { background-color: #1e1f22; color: #ccc; padding: 10px; margin-top: 10px; border-radius: 6px; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; max-height: 150px; overflow-y: auto; display: none; }

        #chat-container { flex: 1; display: flex; flex-direction: column; max-width: 800px; width: 100%; margin: 0 auto; overflow: hidden; }
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-track { background: var(--bg-color); }
        #chat-window::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 4px; }
        .message { padding: 15px; border-radius: 10px; max-width: 85%; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .user-message { background-color: var(--user-msg-bg); align-self: flex-end; color: white; }
        .ai-message { background-color: var(--ai-msg-bg); align-self: flex-start; }
        #chat-form-container { padding: 0 20px 20px 20px; }
        #chat-form { display: flex; gap: 10px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        #prompt-input { flex: 1; padding: 12px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 16px; resize: none; }
        #prompt-input:focus { outline: none; border-color: var(--user-msg-bg); }
        #send-btn { padding: 0 20px; background-color: var(--user-msg-bg); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        #send-btn:disabled { background-color: #565869; cursor: not-allowed; }
        .loader { width: 1.2em; height: 1.2em; display: inline-block; animation: spin 1s linear infinite; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app-header">
        <div class="header-group">
            <label for="model-select">Active Model</label>
            <select id="model-select"></select>
        </div>
        <div class="header-group">
            <label for="pull-model-input">Pull a New Model</label>
            <div id="pull-controls">
                <input type="text" id="pull-model-input" placeholder="e.g., phi3">
                <button id="pull-model-btn">Pull</button>
            </div>
        </div>
    </div>
    <pre id="pull-status"></pre>

    <div id="chat-container">
        <div id="chat-window">
            <!-- Messages appear here -->
        </div>
        <div id="chat-form-container">
            <form id="chat-form">
                <textarea id="prompt-input" placeholder="Message Ollama..." rows="1"></textarea>
                <button id="send-btn" type="submit">Send</button>
            </form>
        </div>
    </div>

    <script>
        const OLLAMA_BASE_URL = `${window.location.origin}`;
        
        const chatWindow = document.getElementById("chat-window");
        const chatForm = document.getElementById("chat-form");
        const promptInput = document.getElementById("prompt-input");
        const sendButton = document.getElementById("send-btn");
        const modelSelect = document.getElementById("model-select");
        const pullModelInput = document.getElementById("pull-model-input");
        const pullModelBtn = document.getElementById("pull-model-btn");
        const pullStatus = document.getElementById("pull-status");

        let conversationHistory = [];

        async function populateModels() {
            try {
                // --- THIS IS THE CORRECTED LINE ---
                const response = await fetch(`${OLLAMA_BASE_URL}/api/tags`);
                const data = await response.json();
                
                modelSelect.innerHTML = '';
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.innerText = model.name;
                        modelSelect.appendChild(option);
                    });
                } else {
                    addMessage("No models available. Pull a model using the controls above.", "ai");
                }
            } catch (error) {
                console.error("Error fetching models:", error);
                addMessage("Error connecting to Ollama. Make sure the Docker container is running and CORS is configured.", "ai");
            }
        }

        async function pullModel() {
            const modelToPull = pullModelInput.value.trim();
            if (!modelToPull) return;

            pullStatus.style.display = 'block';
            pullStatus.innerText = `Starting pull for "${modelToPull}"...`;
            pullModelBtn.disabled = true;

            try {
                const response = await fetch(`${OLLAMA_BASE_URL}/api/pull`, {
	            method: 'POST',
        	    headers: { 'Content-Type': 'application/json' },
            	    body: JSON.stringify({ name: modelToPull, stream: true }),
               });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');
                    for (const line of lines) {
                        const parsed = JSON.parse(line);
                        let statusText = parsed.status;
                        if (parsed.total && parsed.completed) {
                            const percent = Math.round((parsed.completed / parsed.total) * 100);
                            statusText += ` - ${percent}%`;
                        }
                        pullStatus.innerText = statusText;
                        pullStatus.scrollTop = pullStatus.scrollHeight;
                    }
                }
                pullStatus.innerText += "\nPull complete!";
                await populateModels(); // Refresh the model list
                
            } catch (error) {
                pullStatus.innerText += `\nError pulling model: ${error.message}`;
                console.error("Error pulling model:", error);
            } finally {
                pullModelInput.value = '';
                pullModelBtn.disabled = false;
                setTimeout(() => { pullStatus.style.display = 'none'; }, 5000);
            }
        }

        async function handleUserMessage(prompt) {
            const selectedModel = modelSelect.value;
            if (!selectedModel) {
                addMessage("Please select a model from the dropdown first.", "ai");
                return;
            }

            addMessage(prompt, "user");
            conversationHistory.push({ role: "user", content: prompt });
            
            promptInput.value = "";
            promptInput.style.height = 'auto';
            toggleForm(false);
            
            const aiMessageElement = addMessage("...", "ai");
            
            try {
                const response = await fetch(`${OLLAMA_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: selectedModel, messages: conversationHistory, stream: true }),
                });

                if (!response.ok) { throw new Error(`HTTP error! Status: ${response.status}`); }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = "";
                aiMessageElement.innerText = "";
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');
                    for (const line of lines) {
                        const parsed = JSON.parse(line);
                        const content = parsed.message.content;
                        if (content) {
                            fullResponse += content;
                            aiMessageElement.innerText = fullResponse;
                            chatWindow.scrollTop = chatWindow.scrollHeight;
                        }
                        if (parsed.done) {
                            conversationHistory.push({ role: "assistant", content: fullResponse });
                            toggleForm(true);
                        }
                    }
                }
            } catch (error) {
                console.error("Error during chat:", error);
                aiMessageElement.innerText = `Error: ${error.message}`;
                aiMessageElement.style.color = '#ff8a80';
                toggleForm(true);
            }
        }

        function addMessage(text, sender) { const el = document.createElement("div"); el.classList.add("message", `${sender}-message`); el.innerText = text; chatWindow.appendChild(el); el.scrollIntoView(); return el; }
        function toggleForm(isEnabled) { promptInput.disabled = !isEnabled; sendButton.disabled = !isEnabled; if (isEnabled) { promptInput.focus(); sendButton.innerHTML = 'Send'; } else { sendButton.innerHTML = '<div class="loader"></div>'; } }
        
        chatForm.addEventListener("submit", (e) => { e.preventDefault(); const p = promptInput.value.trim(); if (p) { handleUserMessage(p); } });
        promptInput.addEventListener('input', () => { promptInput.style.height = 'auto'; promptInput.style.height = `${promptInput.scrollHeight}px`; });
        promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); chatForm.dispatchEvent(new Event('submit')); } });
        pullModelBtn.addEventListener('click', pullModel);

        document.addEventListener('DOMContentLoaded', () => {
            populateModels();
            addMessage("Welcome! Select an available model or pull a new one to begin.", "ai");
        });
    </script>
</body>
</html>
